--[[  ===== 忍者注入器-NinjaInjector v1.0 =====  ]]
--  功能：1. 原地加载整套 GUI
--        2. 支持热键隐藏/显示（默认 RightShift）
--        3. 支持双击顶部拖动条快速最小化
--        4. 支持自动保存配置（本地）
--  用法：require(脚本) 即可，零配置
---------------------------------------------------

local player = game:GetService("Players").LocalPlayer
local UIS    = game:GetService("UserInputService")
local TS     = game:GetService("TweenService")
local Http   = game:GetService("HttpService")

-- 防止重复注入
if player:FindFirstChild("__NINJA_MARKER") then return end
local marker = Instance.new("BoolValue"); marker.Name = "__NINJA_MARKER"; marker.Parent = player

---------------------------------------------------
-- 1) 保存/读取本地配置
---------------------------------------------------
local CONFIG = { minimised = false, visible = true }
local CONFIG_NAME = "NinjaConfig.json"

local function loadConfig()
    local suc, data = pcall(function()
        return Http:JSONDecode(readfile(CONFIG_NAME))
    end)
    if suc then
        for k,v in pairs(data) do CONFIG[k]=v end
    end
end

local function saveConfig()
    writefile(CONFIG_NAME, Http:JSONEncode(CONFIG))
end

-- 仅在支持文件系统的环境执行（Synapse, Script-Ware, KRNL…）
if isfile and writefile then
    loadConfig()
end

---------------------------------------------------
-- 2) GUI 初始化
---------------------------------------------------
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NinjaGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = CONFIG.minimised and UDim2.new(0,0,0,0) or UDim2.new(0.4,0,0.6,0)
mainFrame.Position = UDim2.new(0.5,0,0.5,0)
mainFrame.AnchorPoint = Vector2.new(0.5,0.5)
mainFrame.BackgroundTransparency = 0.3
mainFrame.Parent = screenGui

local g = Instance.new("UIGradient")
g.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255,0,128)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(0,0,255))
}
g.Rotation = 45
g.Parent = mainFrame

Instance.new("UICorner").Parent = mainFrame

-- 拖动条（双击最小化）
local dragBar = Instance.new("TextButton")
dragBar.Size = UDim2.new(1,0,0,20)
dragBar.BackgroundTransparency = 1
dragBar.Text = ""
dragBar.Parent = mainFrame
MakeDraggable(mainFrame, dragBar)

-- 双击最小化
local lastClick = 0
dragBar.MouseButton1Click:Connect(function()
    local now = tick()
    if now - lastClick < 0.3 then
        toggleMinimise()
    end
    lastClick = now
end)

---------------------------------------------------
-- 3) 侧边栏 & 页面（沿用你原本逻辑，精简）
---------------------------------------------------
local buttonsFrame = Instance.new("Frame")
buttonsFrame.Size = UDim2.new(0.25,0,0.9,0)
buttonsFrame.Position = UDim2.new(0.02,0,0.05,0)
buttonsFrame.BackgroundTransparency = 0.5
buttonsFrame.Visible = not CONFIG.minimised
buttonsFrame.Parent = mainFrame
Instance.new("UICorner").Parent = buttonsFrame)

local list = Instance.new("UIListLayout")
list.Parent = buttonsFrame
list.Padding = UDim.new(0.05,0)

local pages = {}
local currentPage

local buttonTexts = {"公告","绘制","功能","杂项"}

-- 创建页面函数
local function createPage(name)
    local p = Instance.new("Frame")
    p.Name = name
    p.Size = UDim2.new(0.7,0,0.8,0)
    p.Position = UDim2.new(0.28,0,0.1,0)
    p.BackgroundTransparency = 0.5
    p.BackgroundColor3 = Color3.new(1,1,1)
    p.Visible = false
    p.Parent = mainFrame
    Instance.new("UICorner").Parent = p

    -- ScrollingFrame 示例
    local sf = Instance.new("ScrollingFrame")
    sf.Size = UDim2.new(1,0,0.8,0)
    sf.BackgroundTransparency = 1
    sf.ScrollBarThickness = 5
    sf.CanvasSize = UDim2.new(0,0,2,0)
    sf.Parent = p

    for i=1,10 do
        local lb = Instance.new("TextLabel")
        lb.Size = UDim2.new(1,0,0.1,0)
        lb.Position = UDim2.new(0,0,0.1*(i-1),0)
        lb.BackgroundTransparency = 1
        lb.Text = name.." 内容 "..i
        lb.TextColor3 = Color3.new(0,0,0)
        lb.Font = Enum.Font.SourceSansBold
        lb.TextSize = 16
        lb.Parent = sf
    end

    return p
end

-- 初始化
for _,txt in ipairs(buttonTexts) do
    pages[txt] = createPage(txt)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.9,0,0.12,0)
    btn.Text = txt
    btn.BackgroundColor3 = Color3.fromRGB(0,0,0)
    btn.BackgroundTransparency = 0.5
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 16
    btn.Parent = buttonsFrame
    Instance.new("UICorner").Parent = btn
    btn.MouseButton1Click:Connect(function()
        if currentPage then currentPage.Visible=false end
        pages[txt].Visible = true
        currentPage = pages[txt]
    end)
end

---------------------------------------------------
-- 4) 最小化/展开
---------------------------------------------------
function toggleMinimise()
    CONFIG.minimised = not CONFIG.minimised
    if CONFIG.minimised then
        TS:Create(mainFrame, TweenInfo.new(0.3), {Size=UDim2.new(0,0,0,0)}):Play()
        buttonsFrame.Visible = false
    else
        TS:Create(mainFrame, TweenInfo.new(0.3), {Size=UDim2.new(0.4,0,0.6,0)}):Play()
        buttonsFrame.Visible = true
    end
    if writefile then saveConfig() end
end

---------------------------------------------------
-- 5) 热键隐藏/显示
---------------------------------------------------
UIS.InputBegan:Connect(function(inp, gpe)
    if gpe then return end
    if inp.KeyCode == Enum.KeyCode.RightShift then
        CONFIG.visible = not CONFIG.visible
        screenGui.Enabled = CONFIG.visible
        if writefile then saveConfig() end
    end
end)

---------------------------------------------------
-- 6) 工具：拖动函数
---------------------------------------------------
function MakeDraggable(obj, handle)
    handle = handle or obj
    local drag, input, start, pos
    handle.InputBegan:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseButton1 then
            drag = true
            start = inp.Position
            pos = obj.Position
            inp.Changed:Connect(function()
                if inp.UserInputState == Enum.UserInputState.End then
                    drag = false
                end
            end)
        end
    end)
    UIS.InputChanged:Connect(function(inp)
        if inp.UserInputType == Enum.UserInputType.MouseMovement and drag then
            local delta = inp.Position - start
            obj.Position = UDim2.new(pos.X.Scale, pos.X.Offset + delta.X,
                                     pos.Y.Scale, pos.Y.Offset + delta.Y)
        end
    end)
end

---------------------------------------------------
-- 7) 初始化完毕
---------------------------------------------------
print("🥷 忍者注入器已就绪 | 双击顶部可最小化 | 按 RightShift 隐藏")
